use crate::metadata::BenchmarkCrate;
use std::path::Path;

/// Generate runner.rs source code
///
/// Creates a Rust program that:
/// 1. Declares extern crate for all benchmark crates
/// 2. Uses inventory to collect all benchmarks
/// 3. Runs each benchmark and displays results
pub fn generate_runner(benchmark_crates: &[BenchmarkCrate]) -> String {
    let mut code = String::new();

    // Add header comment
    code.push_str("// Generated by cargo-simplebench\n");
    code.push_str("// This runner collects and executes all benchmarks from the workspace\n\n");

    // Add extern declarations for runtime crates
    code.push_str("extern crate simplebench_runtime;\n");
    code.push_str("extern crate inventory;\n\n");

    // Add extern declarations for all benchmark crates
    for crate_info in benchmark_crates {
        let crate_name = crate_info.name.replace('-', "_");
        code.push_str(&format!("extern crate {};\n", crate_name));
    }

    code.push_str("\n");

    // Add main function
    code.push_str("fn main() {\n");
    code.push_str("    use simplebench_runtime::SimpleBench;\n\n");

    code.push_str("    // Collect all registered benchmarks\n");
    code.push_str("    let benchmarks: Vec<&SimpleBench> = inventory::iter::<SimpleBench>().collect();\n\n");

    code.push_str("    println!(\"Found {} benchmarks:\\n\", benchmarks.len());\n\n");

    code.push_str("    if benchmarks.is_empty() {\n");
    code.push_str("        eprintln!(\"ERROR: No benchmarks found!\");\n");
    code.push_str("        eprintln!(\"Make sure your benchmark functions are marked with #[mbench]\");\n");
    code.push_str("        std::process::exit(1);\n");
    code.push_str("    }\n\n");

    code.push_str("    // Run each benchmark\n");
    code.push_str("    for bench in &benchmarks {\n");
    code.push_str("        println!(\"Running: {}::{}\", bench.module, bench.name);\n");
    code.push_str("        (bench.func)();\n");
    code.push_str("        println!(\"  [PASSED]\\n\");\n");
    code.push_str("    }\n\n");

    code.push_str("    println!(\"\\nAll {} benchmarks completed successfully.\", benchmarks.len());\n");
    code.push_str("}\n");

    code
}

/// Write runner.rs to a file
pub fn write_runner(target_dir: &Path, benchmark_crates: &[BenchmarkCrate]) -> Result<std::path::PathBuf, std::io::Error> {
    let runner_code = generate_runner(benchmark_crates);
    let runner_path = target_dir.join("simplebench_runner.rs");
    std::fs::write(&runner_path, runner_code)?;
    Ok(runner_path)
}
